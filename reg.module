<?php
/**
* Anthrocon's registration module.
*
* This code is copyright 2008 by Douglas Muth.  Permission is granted
*	to redistribute under the Gnu Public License.
*
*/

/**
* Define our autoloader, and register it.
*/
function reg_autoload($class) {
	//print "$class<br>\n"; // Debugging
	$class = str_replace("_", "/", $class);
	//print "$class<br>\n"; // Debugging
	$file = $class . ".class.php";
	//print "$file<br>\n"; // Debugging
	include_once($file);
}

spl_autoload_register("reg_autoload");


/**
* Create our factory instance.
*/
$GLOBALS["reg_factory"] = new reg_factory();


/**
* Our list of permissions
*/
function reg_perm() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	return($reg->perm());
}


function reg_init() {
}


function reg_exit() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->hook_exit();
}



/**
* Create our menu items.
*
* Do NOT name the underlying class reg_menu!  If a function and class
*	share identical names in PHP 5.2.4, all sorts of bad things happen!
*	I learned this the hard way. :-(
*
* Though on second thought, I've since considered that maybe my PHP 
*	cache (APC) was caching non-existant files when I moved the one
*	reg/ directory out of the way to make way for a new installation,
*	AND restarting the php-cgi process seemed to fix the problem.  This
*	will require more investigation in the future.
*/
function reg_menu($may_cache) {

	$menu = $GLOBALS["reg_factory"]->get_object("menu");
	$items = $menu->menu($may_cache);
	return($items);

} // End of reg_menu()


/**
* Our public verification page.
*/
function reg_verify($id_email = "") {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$verify = $GLOBALS["reg_factory"]->get_object("verify");
	$retval = $verify->verify($id_email);

	return($retval);
} 

function reg_verify_form() {
	$verify = $GLOBALS["reg_factory"]->get_object("verify");
	$retval = $verify->verify_form();
	return($retval);
}

function reg_verify_form_validate($form_id, &$data) {
	$verify = $GLOBALS["reg_factory"]->get_object("verify");
	$verify->verify_validate($form_id, $data);
}

function reg_verify_form_submit($form_id, &$data) {
	$verify = $GLOBALS["reg_factory"]->get_object("verify");
	$retval = $verify->verify_submit($form_id, $data);
	return($retval);
}


/**
* Our "success" page.
*/
function reg_success() {
	$success = $GLOBALS["reg_factory"]->get_object("success");
	$retval = $success->success();
	return($retval);
}


/**
* Our public registration page.
*/
function reg_registration() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");

	$reg->force_ssl();
	return($reg->registration());
}

function reg_registration_form($id = "") {

	$auth_factory = new authorize_net_factory();

	$cc_gateway = $auth_factory->get_object("authorize_net");
	$form = $GLOBALS["reg_factory"]->get_object("form");

	return($form->reg($id, $cc_gateway));

}

function reg_registration_form_validate($form_id, &$data) {

	$auth_factory = new authorize_net_factory();

	$cc_gateway = $auth_factory->get_object("authorize_net");
	$form = $GLOBALS["reg_factory"]->get_object("form");

	$form->reg_validate($form_id, $data, $cc_gateway);

}

function reg_registration_form_submit($form_id, &$data) {

	$form = $GLOBALS["reg_factory"]->get_object("form");

	return($form->reg_submit($form_id, $data));

}


/**
* Our onsite registration form.
*/
function reg_onsitereg() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$onsite = $GLOBALS["reg_factory"]->get_object("OnsiteDisplay");
	return($onsite->getPage());
}

function reg_onsitereg_form() {
	$onsite = $GLOBALS["reg_factory"]->get_object("OnsiteDisplay");
	return($onsite->getForm());
}

function reg_onsitereg_form_validate($form_id, &$data) {
	$onsite = $GLOBALS["reg_factory"]->get_object("OnsiteDisplay");
	return($onsite->getFormValidate($form_id, $data));
}

function reg_onsitereg_form_submit($form_id, &$data) {
	$onsite = $GLOBALS["reg_factory"]->get_object("OnsiteDisplay");
	return($onsite->getFormSubmit($form_id, $data));
}

function reg_onsitereg_success() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$onsite = $GLOBALS["reg_factory"]->get_object("OnsiteDisplay");
	return($onsite->getSuccessPage());
}


/**
* Our settings form.
*/
function reg_admin_settings() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings");
	$retval = $settings->settings();
	return($retval);
}

function reg_admin_settings_form() {
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings");
	$retval = $settings->settings_form();
	return($retval);
}

function reg_admin_settings_form_validate($form_id, $data) {
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings");
	$settings->settings_form_validate($form_id, $data);
}

function reg_admin_settings_form_submit($form_id, $data) {
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings");
	$settings->settings_form_submit($form_id, $data);
}


/**
* Messages admin.
*/
function reg_admin_settings_messages() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings_message");
	return($settings->messages());
}

function reg_admin_settings_messages_edit($id = "") {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings_message");
	return($settings->edit($id));
}

function reg_admin_settings_message_form($id) {
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings_message");
	return($settings->form($id));
}

function reg_admin_settings_message_form_validate($form_id, $data) {
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings_message");
	return($settings->form_validate($form_id, $data));
}

function reg_admin_settings_message_form_submit($form_id, $data) {
	$settings = $GLOBALS["reg_factory"]->get_object("admin_settings_message");
	return($settings->form_submit($form_id, $data));
}

/**
* Membership level editing stuff.
*/
function reg_admin_levels() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$level = $GLOBALS["reg_factory"]->get_object("admin_level");
	return($level->levels());
}

function reg_admin_levels_edit($id = "") {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$level = $GLOBALS["reg_factory"]->get_object("admin_level");
	return($level->levels_edit($id));
}

function reg_admin_level_form($id) {
	$level = $GLOBALS["reg_factory"]->get_object("admin_level");
	return($level->level_form($id));
}

function reg_admin_level_form_validate($form_id, $data) {
	$level = $GLOBALS["reg_factory"]->get_object("admin_level");
	return($level->level_form_validate($form_id, $data));
}

function reg_admin_level_form_submit($form_id, $data) {
	$level = $GLOBALS["reg_factory"]->get_object("admin_level");
	return($level->level_form_submit($form_id, $data));
}


/**
* Viewing recent registrations.
*/
function reg_admin_members() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->recent());
}

function reg_admin_members_view($id) {
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->view_reg($id));
}

function reg_admin_members_edit($id) {
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->edit_reg($id));
}


/**
* Our "Add a note" form.
*/
function reg_admin_members_add_note($id) {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->add_note($id));
}

function reg_admin_members_add_note_form($id) {
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->add_note_form($id));
}

function reg_admin_members_add_note_form_validate($form_id, &$data) {
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->add_note_form_validate($form_id, $data));
}

function reg_admin_members_add_note_form_submit($form_id, &$data) {
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->add_note_form_submit($form_id, $data));
}


/**
* Cancellation form for admins.
*/
function reg_admin_members_cancel($id) {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$cancel = $GLOBALS["reg_factory"]->get_object("admin_cancel");
	return($cancel->cancel($id));
}

function reg_admin_members_cancel_form($id) {
	$cancel = $GLOBALS["reg_factory"]->get_object("admin_cancel");
	return($cancel->form($id));
}

function reg_admin_members_cancel_form_validate($form_id, $data) {
	$cancel = $GLOBALS["reg_factory"]->get_object("admin_cancel");
	return($cancel->form_validate($form_id, $data));
}

function reg_admin_members_cancel_form_submit($form_id, $data) {
	$cancel = $GLOBALS["reg_factory"]->get_object("admin_cancel");
	return($cancel->form_submit($form_id, $data));
}


/**
* Balance adjustments
*/
function reg_admin_members_adjust($id) {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$adjust = $GLOBALS["reg_factory"]->get_object("admin_adjust");
	return($adjust->adjust($id));
}

function reg_admin_members_adjust_form($id) {
	$adjust = $GLOBALS["reg_factory"]->get_object("admin_adjust");
	return($adjust->form($id));
}

function reg_admin_members_adjust_form_validate($form_id, $data) {
	$adjust = $GLOBALS["reg_factory"]->get_object("admin_adjust");
	return($adjust->form_validate($form_id, $data));
}

function reg_admin_members_adjust_form_submit($form_id, $data) {
	$adjust = $GLOBALS["reg_factory"]->get_object("admin_adjust");
	return($adjust->form_submit($form_id, $data));
}


/**
* Printing individual badges.
*/
function reg_admin_members_print($id) {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintBadge");
	return($util->getPage($id));
}

function reg_admin_members_print_form($id) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintBadge");
	return($util->getForm($id));
}

function reg_admin_members_print_form_validate($form_id, $data) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintBadge");
	return($util->getFormValidate($form_id, $data));
}

function reg_admin_members_print_form_submit($form_id, $data) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintBadge");
	return($util->getFormSubmit($form_id, $data));
}


/**
* Validating onsite registrations.
*/
function reg_admin_members_validate($id) {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$util = $GLOBALS["reg_factory"]->get_object("OnsiteValidate");
	return($util->getPage($id));
}

function reg_admin_members_validate_form($id) {
	$util = $GLOBALS["reg_factory"]->get_object("OnsiteValidate");
	return($util->getForm($id));
}

function reg_admin_members_validate_form_validate($form_id, $data) {
	$util = $GLOBALS["reg_factory"]->get_object("OnsiteValidate");
	return($util->getFormValidate($form_id, $data));
}

function reg_admin_members_validate_form_submit($form_id, $data) {
	$util = $GLOBALS["reg_factory"]->get_object("OnsiteValidate");
	return($util->getFormSubmit($form_id, $data));
}


/**
* Searching registrations.
*/
function reg_admin_search() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$search = $GLOBALS["reg_factory"]->get_object("admin_search");
	$retval = $search->search();
	$retval .= $search->results();
	return($retval);
}

function reg_admin_search_download() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$search = $GLOBALS["reg_factory"]->get_object("admin_search_download");

	//
	// We'll exit after printing the results of this function, as we
	// want to allow the user to download the data.
	//
	$retval = $search->download();
	print $retval;
	exit();
} 

function reg_admin_search_form() {
	$search = $GLOBALS["reg_factory"]->get_object("admin_search");
	return($search->search_form());
}

function reg_admin_search_form_validate($form_id, &$data) {
	$search = $GLOBALS["reg_factory"]->get_object("admin_search");
	$search->search_validate($form_id, $data);
}

function reg_admin_search_form_submit($form_id, &$data) {
	$search = $GLOBALS["reg_factory"]->get_object("admin_search");
	return($search->search_submit($form_id, $data));
}


/**
* Adding a new registration.
*/
function reg_admin_members_add() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$member = $GLOBALS["reg_factory"]->get_object("admin_member");
	return($member->add_reg());
}

/**
* Viewing logs.
*/
function reg_admin_log() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$log = $GLOBALS["reg_factory"]->get_object("admin_log_search");
	return($log->log_recent());
}

function reg_admin_log_search_form() {
	$search = $GLOBALS["reg_factory"]->get_object("admin_log_search");
	return($search->search_form());
}

function reg_admin_log_search_form_validate($form_id, &$data) {
	$search = $GLOBALS["reg_factory"]->get_object("admin_log_search");
	return($search->search_form_validate($form_id, $data));
}

function reg_admin_log_search_form_submit($form_id, &$data) {
	$search = $GLOBALS["reg_factory"]->get_object("admin_log_search");
	return($search->search_form_submit($form_id, $data));
}


function reg_admin_log_detail($id) {
	$log = $GLOBALS["reg_factory"]->get_object("admin_log_view");
	return($log->log_detail($id));
}

function reg_admin_trans() {
	$log = $GLOBALS["reg_factory"]->get_object("admin_log_view");
	return($log->trans_recent());
}

function reg_admin_trans_detail($id) {
	$log = $GLOBALS["reg_factory"]->get_object("admin_log_view");
	return($log->trans_detail($id));
}

function reg_admin_main() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$admin = $GLOBALS["reg_factory"]->get_object("admin");
	return($admin->main());

}

/**
* Viewing registration stats.
*/
function reg_admin_stats_reg() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$stats = $GLOBALS["reg_factory"]->get_object("admin_stats");
	return($stats->get_stats_reg());

}

function reg_admin_stats_badge() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$stats = $GLOBALS["reg_factory"]->get_object("admin_stats");
	return($stats->get_stats_badge());

}

function reg_admin_stats_revenue() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$stats = $GLOBALS["reg_factory"]->get_object("admin_stats");
	return($stats->get_stats_revenue());

}


/**
* Unused badge numbers.
*/
function reg_admin_utils_unused_badge_nums() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$util = $GLOBALS["reg_factory"]->get_object("Util_UnusedBadgeNumsDisplay");
	$retval = $util->go($id_email);

	return($retval);

}

function reg_admin_utils_unused_badge_nums_form() {

	$util = $GLOBALS["reg_factory"]->get_object("Util_UnusedBadgeNumsDisplay");
	$retval = $util->getForm();
	return($retval);

}

function reg_admin_utils_unused_badge_nums_form_submit($form_id, &$data) {

	$util = $GLOBALS["reg_factory"]->get_object("Util_UnusedBadgeNumsDisplay");
	$retval = $util->getFormSubmit($form_id, $data);
	return($retval);

}


/**
* Duplicate membership reports.
*/
function reg_admin_utils_duplicate() {

	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();

	$util = $GLOBALS["reg_factory"]->get_object("Util_DuplicateDisplay");
	$retval = $util->go($id_email);

	return($retval);

}

function reg_admin_utils_duplicate_form() {

	$util = $GLOBALS["reg_factory"]->get_object("Util_DuplicateDisplay");
	$retval = $util->getForm();
	return($retval);

}

function reg_admin_utils_duplicate_form_submit($form_id, &$data) {

	$util = $GLOBALS["reg_factory"]->get_object("Util_DuplicateDisplay");
	$retval = $util->getFormSubmit($form_id, $data);
	return($retval);

}


/**
* Functions for viewing and editing the watchlist.
*/
function reg_admin_utils_watchlist() {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$util = $GLOBALS["reg_factory"]->get_object("Util_WatchlistDisplay");
	return($util->getAll());
}

function reg_admin_utils_watchlist_edit($id = "") {
	$reg = $GLOBALS["reg_factory"]->get_object("reg");
	$reg->force_ssl();
	$util = $GLOBALS["reg_factory"]->get_object("Util_WatchlistDisplay");
	return($util->getEditPage($id));
}

function reg_admin_utils_watchlist_form($id) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_WatchlistDisplay");
	return($util->getForm($id));
}

function reg_admin_utils_watchlist_form_validate($form_id, $data) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_WatchlistDisplay");
	return($util->getFormValidate($form_id, $data));
}

function reg_admin_utils_watchlist_form_submit($form_id, $data) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_WatchlistDisplay");
	return($util->getFormSubmit($form_id, $data));
}

/**
* Display the current print queue.
*/
function reg_admin_utils_print_queue() {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintDisplay");
	return($util->getPage());
}

function reg_admin_utils_print_queue_form() {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintDisplay");
	return($util->getForm());
}

function theme_reg_admin_utils_print_queue_form($form) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintDisplay");
	return($util->getFormTheme($form));
}

function reg_admin_utils_print_queue_form_validate($form_id, &$data) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintDisplay");
	return($util->getFormValidate($form_id, $data));
}

function reg_admin_utils_print_queue_form_submit($form_id, &$data) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintDisplay");
	return($util->getFormSubmit($form_id, $data));
}


/**
* Monitor the print queue for jobs and print them.
*/
function reg_admin_utils_print_client() {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintClient");
	return($util->getPage());
}

function reg_admin_utils_print_client_form() {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintClient");
	return($util->getForm());
}

/**
* AJAX calls for interacting with print jobs.
*/
function reg_admin_utils_print_ajax_fetch($printer = "") {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintAjax");
	print $util->fetch($printer);
}

function reg_admin_utils_print_ajax_update($id, $status) {
	$util = $GLOBALS["reg_factory"]->get_object("Util_PrintAjax");
	$util->update($id, $status);
	exit();
}

/**
* Our theme function for creating form elements in the reg system.
*/
function theme_reg_theme($form) {
	$theme = $GLOBALS["reg_factory"]->get_object("theme");
	$retval = $theme->theme($form);
	return($retval);
}



